<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Add Test Image via Webcam</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      #video {
        border: 2px solid #333;
        border-radius: 8px;
        max-width: 320px;
      }
      #canvas {
        display: none;
      }
    </style>
  </head>
  <body class="container bg-light mt-5">
    <h1>Capture Test Image & USN</h1>
    <form id="testImageForm" method="POST" enctype="multipart/form-data">
      <div class="mb-3">
        <label for="usn" class="form-label">Enter or select USN:</label>
        <input
          type="text"
          class="form-control"
          id="usn"
          name="usn"
          required
          placeholder="e.g. 4MC22IS099"
          list="usn-list"
        />
        <datalist id="usn-list">
          {% for student in students %}
          <option value="{{ student.usn }}">{{ student.name }}</option>
          {% endfor %}
        </datalist>
      </div>

      <div class="mb-3">
        <video id="video" autoplay></video>
        <button type="button" id="snapBtn" class="btn btn-primary mt-2">
          Capture Photo
        </button>
      </div>

      <canvas id="canvas" width="320" height="240"></canvas>
      <input type="hidden" name="image_data" id="image_data" />
      <button type="submit" class="btn btn-success mt-3">Upload Image</button>
    </form>
    {% with messages = get_flashed_messages() %} {% if messages %}
    <div class="alert alert-info mt-3">
      {% for message in messages %}{{ message }}{% endfor %}
    </div>
    {% endif %} {% endwith %}

    <script>
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const snapBtn = document.getElementById("snapBtn");
      const imageDataInput = document.getElementById("image_data");

      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
          video.srcObject = stream;
          video.play();
        });
      } else {
        alert("Webcam not supported on this browser.");
      }

      snapBtn.addEventListener("click", function () {
        const context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const dataURL = canvas.toDataURL("image/jpeg");
        imageDataInput.value = dataURL;
        alert("Photo captured! Now click Upload Image to submit.");
      });

      document
        .getElementById("testImageForm")
        .addEventListener("submit", function (e) {
          if (!imageDataInput.value) {
            e.preventDefault();
            alert("Please capture a photo before uploading.");
          }
        });
    </script>
  </body>
</html>
